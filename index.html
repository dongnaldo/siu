<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIU Community</title>

  <style>
    body { font-family: Arial; padding: 20px; }
    .postItem {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fafafa;
    }
    .commentBox {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }
    .commentInput {
      width: 70%;
      padding: 6px;
    }
    .commentBtn {
      padding: 6px 12px;
    }
    .commentList div {
      margin-top: 5px;
      padding: 5px 8px;
      background: #efefef;
      border-radius: 6px;
    }
    .authorLink {
      color: blue;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>

<body>

  <!-- 상단 네비게이션 메뉴 (로그인 상태에 따라 바뀜) -->
  <div class="topMenu" style="position:fixed; top:10px; right:10px; display:flex; gap:10px;">
    <a href="index.html" style="padding:6px 10px; background:white; border:1px solid #ddd; border-radius:5px; text-decoration:none;">홈</a>

    <div id="authMenu">
      <a href="login.html" style="padding:6px 10px; background:white; border:1px solid #ddd; border-radius:5px; text-decoration:none;">로그인</a>
      <a href="signup.html" style="padding:6px 10px; background:white; border:1px solid #ddd; border-radius:5px; text-decoration:none;">회원가입</a>
    </div>

    <div id="userMenu" style="display:none;">
      <a href="profile.html" style="padding:6px 10px; background:white; border:1px solid #ddd; border-radius:5px; text-decoration:none;">내 프로필</a>
      <a href="#" id="logoutBtn" style="padding:6px 10px; background:#ffe6e6; border:1px solid #ffaaaa; border-radius:5px; text-decoration:none;">로그아웃</a>
    </div>
  </div>

  <h2>게시글 작성</h2>

  <input type="text" id="titleInput" placeholder="제목 입력" />
  <br /><br />

  <textarea id="contentInput" placeholder="내용 입력"></textarea>
  <br /><br />

  <button id="addPostBtn">게시글 추가</button>

  <hr />

  <h2>게시글 목록</h2>
  <div id="postList"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyBgKHGln9fdP3Fo4P_cm0CK3Vwl4GeTeUE",
      authDomain: "dongnaldo-51239.firebaseapp.com",
      projectId: "dongnaldo-51239",
      storageBucket: "dongnaldo-51239.appspot.com",
      messagingSenderId: "129624651466",
      appId: "1:129624651466:web:ff1069d13895f9b537e633",
      measurementId: "G-M3M2B819Q3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    /* -------------------------------
       A) 로그인 상태 감지 → UI 업데이트
    ------------------------------- */
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("authMenu").style.display = "none";
        document.getElementById("userMenu").style.display = "flex";
      } else {
        document.getElementById("authMenu").style.display = "flex";
        document.getElementById("userMenu").style.display = "none";
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => location.reload());
    });

    /* -------------------------------
       1) 게시글 추가 (작성자 포함)
    ------------------------------- */
    document.getElementById("addPostBtn").addEventListener("click", async () => {
      const title = document.getElementById("titleInput").value.trim();
      const content = document.getElementById("contentInput").value.trim();

      if (!title || !content) {
        alert("제목과 내용을 입력하세요!");
        return;
      }

      const user = auth.currentUser;

      let postData = {
        title,
        content,
        createdAt: new Date()
      };

      // 로그인한 사람만 작성자 기록
      if (user) {
        postData.authorUid = user.uid;
        postData.authorEmail = user.email;
        postData.authorName = user.email.split("@")[0];
      }

      await db.collection("posts").add(postData);

      alert("게시글 추가 완료!");
      loadPosts();
    });

    /* -------------------------------
       2) 게시글 + 댓글 불러오기
    ------------------------------- */
    async function loadPosts() {
      const postList = document.getElementById("postList");
      postList.innerHTML = "";

      const snapshot = await db.collection("posts")
        .orderBy("createdAt", "desc")
        .get();

      snapshot.forEach(doc => {
        const p = doc.data();

        const box = document.createElement("div");
        box.className = "postItem";

        const authorText = p.authorName
          ? `<a href="profile.html?uid=${p.authorUid}" class="authorLink">${p.authorName}</a>`
          : `<span style="color:#777;">익명</span>`;

        box.innerHTML = `
          <h3>${p.title}</h3>
          <p>${p.content}</p>

          <div><b>작성자:</b> ${authorText}</div>

          <small>${p.createdAt.toDate()}</small>

          <div class="commentBox">
            <input type="text" class="commentInput" placeholder="댓글 입력">
            <button class="commentBtn" data-id="${doc.id}">댓글 달기</button>
            <div class="commentList" id="comments_${doc.id}"></div>
          </div>
        `;

        postList.appendChild(box);

        loadComments(doc.id);
      });
    }

    /* -------------------------------
       3) 댓글 저장 (로그인 여부 반영)
    ------------------------------- */
    document.addEventListener("click", async e => {
      if (!e.target.classList.contains("commentBtn")) return;

      const postId = e.target.getAttribute("data-id");
      const input = e.target.previousElementSibling;
      const text = input.value.trim();

      if (!text) return alert("댓글을 입력하세요!");

      const user = auth.currentUser;

      const commentData = {
        text,
        createdAt: new Date()
      };

      if (user) {
        commentData.nickname = user.email.split("@")[0];
        commentData.userId = user.uid;
      } else {
        commentData.nickname = "익명";
        commentData.userId = "guest";
      }

      await db.collection("posts")
        .doc(postId)
        .collection("comments")
        .add(commentData);

      input.value = "";
      loadComments(postId);
    });

    /* -------------------------------
       4) 댓글 불러오기
    ------------------------------- */
    async function loadComments(postId) {
      const area = document.getElementById("comments_" + postId);
      area.innerHTML = "";

      const snapshot = await db
        .collection("posts")
        .doc(postId)
        .collection("comments")
        .orderBy("createdAt", "asc")
        .get();

      snapshot.forEach(doc => {
        const c = doc.data();
        const div = document.createElement("div");

        div.innerHTML = `
          <b>${c.nickname}</b>: ${c.text}
        `;

        area.appendChild(div);
      });
    }

    loadPosts();
  </script>

</body>
</html>
