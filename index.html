<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIU Community</title>

  <style>
    body { font-family: Arial; padding: 20px; }
    .postItem {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fafafa;
    }
    .commentBox {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }
    .commentInput {
      width: 70%;
      padding: 6px;
    }
    .commentBtn {
      padding: 6px 12px;
    }
    .commentList div {
      margin-top: 5px;
      padding: 5px 8px;
      background: #efefef;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <h2>게시글 작성</h2>

  <input type="text" id="titleInput" placeholder="제목 입력" />
  <br /><br />

  <textarea id="contentInput" placeholder="내용 입력"></textarea>
  <br /><br />

  <button id="addPostBtn">게시글 추가</button>

  <hr />

  <h2>게시글 목록</h2>
  <div id="postList"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyBgKHGln9fdP3Fo4P_cm0CK3Vwl4GeTeUE",
      authDomain: "dongnaldo-51239.firebaseapp.com",
      projectId: "dongnaldo-51239",
      storageBucket: "dongnaldo-51239.firebasestorage.app",
      messagingSenderId: "129624651466",
      appId: "1:129624651466:web:ff1069d13895f9b537e633",
      measurementId: "G-M3M2B819Q3"
    };

    // Firebase 초기화
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();



    /* -------------------------------
       1) 게시글 추가
    ------------------------------- */
    document.getElementById("addPostBtn").addEventListener("click", async () => {
      const title = document.getElementById("titleInput").value.trim();
      const content = document.getElementById("contentInput").value.trim();

      if (!title || !content) {
        alert("제목과 내용을 입력하세요!");
        return;
      }

      await db.collection("posts").add({
        title,
        content,
        createdAt: new Date(),
      });

      alert("게시글 추가 완료!");
      loadPosts();
    });



    /* -------------------------------
       2) 게시글 + 댓글 전체 불러오기
    ------------------------------- */
    async function loadPosts() {
      const postList = document.getElementById("postList");
      postList.innerHTML = "";

      const snapshot = await db
        .collection("posts")
        .orderBy("createdAt", "desc")
        .get();

      snapshot.forEach((doc) => {
        const p = doc.data();

        const box = document.createElement("div");
        box.className = "postItem";

        box.innerHTML = `
          <h3>${p.title}</h3>
          <p>${p.content}</p>
          <small>${p.createdAt.toDate()}</small>

          <div class="commentBox">
            <input type="text" class="commentInput" placeholder="댓글 입력">
            <button class="commentBtn" data-id="${doc.id}">댓글 달기</button>
            <div class="commentList" id="comments_${doc.id}"></div>
          </div>
        `;

        postList.appendChild(box);

        // 댓글 불러오기
        loadComments(doc.id);
      });
    }



    /* -------------------------------
       3) 댓글 저장
    ------------------------------- */
    document.addEventListener("click", async (e) => {
      if (!e.target.classList.contains("commentBtn")) return;

      const postId = e.target.getAttribute("data-id");
      const input = e.target.previousElementSibling;
      const text = input.value.trim();

      if (!text) return alert("댓글을 입력하세요!");

      await db
        .collection("posts")
        .doc(postId)
        .collection("comments")
        .add({
          userId: "guest",
          nickname: "익명",
          text,
          createdAt: new Date(),
        });

      input.value = "";
      loadComments(postId);
    });



    /* -------------------------------
       4) 댓글 불러오기
    ------------------------------- */
    async function loadComments(postId) {
      const commentList = document.getElementById("comments_" + postId);
      commentList.innerHTML = "";

      const snapshot = await db
        .collection("posts")
        .doc(postId)
        .collection("comments")
        .orderBy("createdAt", "asc")
        .get();

      snapshot.forEach((doc) => {
        const c = doc.data();

        const div = document.createElement("div");
        div.textContent = `${c.nickname}: ${c.text}`;
        commentList.appendChild(div);
      });
    }


    // 페이지 열릴 때 실행
    loadPosts();
  </script>
</body>
</html>
